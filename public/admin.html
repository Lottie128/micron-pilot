<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Create Purchase Orders</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header h1 { color: #333; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card h2 { margin-bottom: 20px; color: #333; font-size: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-1px); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }
        .success-msg {
            background: #d1fae5;
            color: #065f46;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        .error-msg {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }
        .po-list { max-height: 600px; overflow-y: auto; }
        .po-item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .po-item h3 { margin-bottom: 8px; color: #333; font-size: 16px; }
        .po-item p { font-size: 13px; color: #666; margin-bottom: 4px; }
        .po-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .po-status.in_progress { background: #dbeafe; color: #1e40af; }
        .po-status.completed { background: #d1fae5; color: #065f46; }
        .po-status.pending { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Admin Panel - Purchase Order Management</h1>
            <p>Create new purchase orders and manage production</p>
        </div>
        
        <div class="main-content">
            <!-- Create PO Form -->
            <div class="card">
                <h2>üìù Create New Purchase Order</h2>
                <form id="poForm">
                    <div class="form-group">
                        <label>PO Number *</label>
                        <input type="text" id="po_number" required placeholder="e.g., PO-2025-003">
                    </div>
                    
                    <div class="form-group">
                        <label>Customer Name *</label>
                        <input type="text" id="customer_name" required placeholder="e.g., ABC Agriculture Ltd">
                    </div>
                    
                    <div class="form-group">
                        <label>Order Date *</label>
                        <input type="date" id="order_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Delivery Date *</label>
                        <input type="date" id="delivery_date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" rows="3" placeholder="Additional notes or instructions"></textarea>
                    </div>
                    
                    <h3 style="margin-top: 20px; margin-bottom: 15px; font-size: 16px; color: #555;">üì¶ Order Items</h3>
                    
                    <div id="itemsContainer">
                        <div class="item-row">
                            <div class="form-group">
                                <label>Part</label>
                                <select class="part-select" required>
                                    <option value="">Loading parts...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" class="quantity-input" required min="1" placeholder="e.g., 500">
                            </div>
                            <button type="button" class="btn btn-danger" onclick="removeItem(this)" style="width: auto; padding: 10px 20px; margin-top: 27px;">‚úï</button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="addItem()" style="margin-bottom: 15px;">+ Add Another Item</button>
                    
                    <button type="submit" class="btn btn-primary">Create Purchase Order</button>
                    
                    <div class="success-msg" id="successMsg"></div>
                    <div class="error-msg" id="errorMsg"></div>
                </form>
            </div>
            
            <!-- Recent POs -->
            <div class="card">
                <h2>üìã Recent Purchase Orders</h2>
                <div class="po-list" id="poList">
                    <p style="text-align: center; color: #999; padding: 20px;">Loading...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '/api';
        let allParts = [];
        
        // Load parts on page load
        async function loadParts() {
            try {
                const response = await fetch(`${API_BASE}/parts.php`);
                const data = await response.json();
                allParts = data.parts || [];
                updateAllPartSelects();
            } catch (error) {
                console.error('Failed to load parts:', error);
            }
        }
        
        function updateAllPartSelects() {
            document.querySelectorAll('.part-select').forEach(select => {
                select.innerHTML = '<option value="">Select a part</option>' +
                    allParts.map(p => `<option value="${p.id}">${p.part_number} - ${p.part_name}</option>`).join('');
            });
        }
        
        function addItem() {
            const container = document.getElementById('itemsContainer');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.innerHTML = `
                <div class="form-group">
                    <label>Part</label>
                    <select class="part-select" required>
                        <option value="">Select a part</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantity</label>
                    <input type="number" class="quantity-input" required min="1" placeholder="e.g., 500">
                </div>
                <button type="button" class="btn btn-danger" onclick="removeItem(this)" style="width: auto; padding: 10px 20px; margin-top: 27px;">‚úï</button>
            `;
            container.appendChild(newRow);
            updateAllPartSelects();
        }
        
        function removeItem(btn) {
            const container = document.getElementById('itemsContainer');
            if (container.children.length > 1) {
                btn.closest('.item-row').remove();
            } else {
                alert('You must have at least one item in the order');
            }
        }
        
        // Load recent POs
        async function loadRecentPOs() {
            try {
                const response = await fetch(`${API_BASE}/po_tracking.php`);
                const data = await response.json();
                const poList = document.getElementById('poList');
                
                if (data.purchase_orders && data.purchase_orders.length > 0) {
                    poList.innerHTML = data.purchase_orders.map(po => `
                        <div class="po-item">
                            <h3>${po.po_number} - ${po.customer_name}</h3>
                            <p><strong>Order Date:</strong> ${po.order_date}</p>
                            <p><strong>Delivery:</strong> ${po.delivery_date}</p>
                            <p><strong>Items:</strong> ${po.total_items || 0} | <strong>Status:</strong> <span class="po-status ${po.status}">${po.status.replace('_', ' ')}</span></p>
                        </div>
                    `).join('');
                } else {
                    poList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No purchase orders yet</p>';
                }
            } catch (error) {
                console.error('Failed to load POs:', error);
            }
        }
        
        // Handle form submission
        document.getElementById('poForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const successMsg = document.getElementById('successMsg');
            const errorMsg = document.getElementById('errorMsg');
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            // Collect items
            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const partId = row.querySelector('.part-select').value;
                const quantity = row.querySelector('.quantity-input').value;
                if (partId && quantity) {
                    items.push({ part_id: partId, quantity: parseInt(quantity) });
                }
            });
            
            if (items.length === 0) {
                errorMsg.textContent = 'Please add at least one item to the order';
                errorMsg.style.display = 'block';
                return;
            }
            
            const poData = {
                po_number: document.getElementById('po_number').value,
                customer_name: document.getElementById('customer_name').value,
                order_date: document.getElementById('order_date').value,
                delivery_date: document.getElementById('delivery_date').value,
                notes: document.getElementById('notes').value,
                items: items
            };
            
            try {
                const response = await fetch(`${API_BASE}/po_tracking.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(poData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    successMsg.textContent = `‚úì Purchase Order ${poData.po_number} created successfully!`;
                    successMsg.style.display = 'block';
                    document.getElementById('poForm').reset();
                    loadRecentPOs();
                } else {
                    errorMsg.textContent = result.error || 'Failed to create purchase order';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                errorMsg.textContent = 'Error: ' + error.message;
                errorMsg.style.display = 'block';
            }
        });
        
        // Set today's date as default
        document.getElementById('order_date').valueAsDate = new Date();
        const deliveryDate = new Date();
        deliveryDate.setDate(deliveryDate.getDate() + 14);
        document.getElementById('delivery_date').valueAsDate = deliveryDate;
        
        // Initialize
        loadParts();
        loadRecentPOs();
        setInterval(loadRecentPOs, 30000); // Refresh every 30 seconds
    </script>
</body>
</html>
